name: Edge Request Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  check-unoptimized-images:
    name: Check for unoptimized external images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@main

      - name: Check for external image URLs without unoptimized prop
        id: image_check
        run: |
          # next/image를 사용하는 파일 중 외부 URL(http/https)을 src로 받는 곳 탐지
          # 단, unoptimized prop이 없는 경우만 에러로 처리

          FOUND=0

          # 1) src에 직접 http URL이 하드코딩된 경우
          while IFS= read -r line; do
            FILE=$(echo "$line" | cut -d: -f1)
            # 해당 파일에 unoptimized가 있는지 확인
            if ! grep -q "unoptimized" "$FILE"; then
              echo "::error file=$FILE::외부 URL을 사용하는 next/image에 unoptimized prop이 없습니다. edge request가 발생할 수 있습니다."
              FOUND=1
            fi
          done < <(grep -rn "src=['\"]https\?://" src/ --include="*.tsx" --include="*.ts" --include="*.jsx" --include="*.js" | grep -i "image\|Image\|img")

          # 2) src에 동적으로 외부 URL이 들어올 수 있는 컴포넌트 탐지
          # (props로 string을 받아서 Image src에 넣는 패턴)
          while IFS= read -r match; do
            FILE=$(echo "$match" | cut -d: -f1)
            LINE=$(echo "$match" | cut -d: -f2)
            # 해당 파일에 unoptimized 또는 isExternalUrl 체크가 있는지 확인
            if ! grep -q "unoptimized" "$FILE"; then
              echo "::warning file=$FILE,line=$LINE::동적 src를 사용하는 next/image에 unoptimized 처리가 없습니다. 외부 URL이 들어올 경우 edge request가 발생할 수 있습니다."
            fi
          done < <(grep -rn "src={[a-zA-Z]" src/ --include="*.tsx" --include="*.jsx" | grep -i "<Image\|<CustomImage\|styled(Image)")

          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "❌ 외부 URL을 사용하는 next/image에 unoptimized prop을 추가해주세요."
            echo "예시: <Image src={externalUrl} unoptimized={true} ... />"
            exit 1
          fi

          echo "✅ 모든 next/image 사용이 올바릅니다."
